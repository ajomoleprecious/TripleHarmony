name: Daily Unverify Users

on:
  schedule:
    # Run once daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  delete-unverified-users:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send DELETE request with retry logic
        run: |
          # Configuration
          URL="https://pokemongame.koyeb.app/pokemon-auth/unverify"
          MAX_ATTEMPTS=12  # 12 attempts * 5 seconds = 60 seconds
          RETRY_DELAY=5    # 5 seconds between retries
          
          attempt=1
          success=false
          last_status=""
          last_response=""
          
          echo "Starting DELETE request to remove unverified users..."
          echo "Will retry for up to 1 minute (every 5 seconds if server is down)"
          echo ""
          
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "Attempt $attempt of $MAX_ATTEMPTS..."
            
            # Make the DELETE request and capture status code and response
            # Use --fail-with-body to get response body even on HTTP errors
            http_code=$(curl -s -w "%{http_code}" -X DELETE "$URL" -o /tmp/response_body.txt)
            curl_exit=$?
            
            # Read response body
            body=$(cat /tmp/response_body.txt 2>/dev/null || echo "")
            
            # Check if curl command succeeded
            if [ $curl_exit -ne 0 ]; then
              status="curl_error_$curl_exit"
              last_status="Network error (curl exit code: $curl_exit)"
              last_response="$body"
              echo "✗ Network error (curl exit code: $curl_exit)"
              if [ -n "$body" ]; then
                echo "Response: $body"
              fi
            else
              status="$http_code"
              last_status="$http_code"
              last_response="$body"
              
              # Check if request was successful (status 2xx)
              if [ "$status" -ge 200 ] && [ "$status" -lt 300 ] 2>/dev/null; then
                echo "✓ Success!"
                echo "HTTP Status: $status"
                echo "Response Body: $body"
                success=true
                break
              else
                echo "✗ Failed with HTTP status: $status"
                echo "Response: $body"
              fi
            fi
            
            # If not the last attempt, wait before retrying
            if [ $attempt -lt $MAX_ATTEMPTS ]; then
              echo "Retrying in $RETRY_DELAY seconds..."
              echo ""
              sleep $RETRY_DELAY
            fi
            
            attempt=$((attempt + 1))
          done
          
          # Clean up temp file
          rm -f /tmp/response_body.txt
          
          # If all attempts failed, log error
          if [ "$success" = false ]; then
            echo ""
            echo "========================================="
            echo "ERROR: All $MAX_ATTEMPTS attempts failed!"
            echo "========================================="
            echo "Last Status: $last_status"
            echo "Last Response Body: $last_response"
            echo "========================================="
            exit 1
          fi
